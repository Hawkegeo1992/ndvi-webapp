<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>üåø NDVI & Soil Moisture Viewer</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
      }
      #map {
        width: 100%;
        height: 60vh;
      }
      #controls {
        padding: 10px;
      }
      select, input, button {
        margin: 5px;
        padding: 8px;
        font-size: 14px;
      }
      #chart_div {
        width: 90%;
        height: 400px;
        margin: auto;
      }
      iframe {
        width: 80%;
        height: 300px;
        border: 1px solid #ccc;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>üåø NDVI & Soil Moisture Viewer</h1>

    <div id="controls">
      <label>Start Date:</label>
      <input type="date" id="start-date" value="2023-01-01" />
      <label>End Date:</label>
      <input type="date" id="end-date" value="2023-03-01" />
      <select id="layer-select">
        <option value="NDVI">NDVI</option>
        <option value="Soil">Soil Moisture</option>
      </select>
      <button id="runBtn" disabled onclick="runAnalysis()">üîç Run Analysis</button>
      <button onclick="drawChart()">üìä Show Chart</button>
      <button onclick="generateAnimation()">üéû Generate Animation</button>
    </div>

    <div id="map"></div>
    <div id="chart_div"></div>
    <iframe id="videoFrame" style="display:none;"></iframe>

    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh9JdQp5xCLsPhB7q7t8U1jLzpXYtbxFg&libraries=drawing&callback=initMap">
    </script>

    <script>
      function loadEarthEngine(callback) {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/@google/earthengine@0.1.265/build/ee_api_js.js";
        script.onload = () => {
          console.log("‚úÖ EE API loaded");
          callback();
        };
        script.onerror = () => console.error("‚ùå Failed to load Earth Engine API.");
        document.head.appendChild(script);
      }

      function initEarthEngine() {
        ee.data.authenticateViaOauth(
          "686935018812-926ilgpd8btttcks8v763mc4gar1seb6.apps.googleusercontent.com",
          () => {
            ee.initialize(null, null, () => {
              console.log("‚úÖ EE initialized");
              document.getElementById("runBtn").disabled = false;
            }, (err) => {
              console.error("‚ùå EE init error:", err);
            });
          },
          (err) => {
            console.error("‚ùå Auth error:", err);
          }
        );
      }

      let map, drawingManager, selectedGeometry = null, initialized = false;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 32.25, lng: 50.75 },
          zoom: 8,
          mapTypeId: "satellite"
        });

        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ["rectangle"]
          }
        });

        drawingManager.setMap(map);
        google.maps.event.addListener(drawingManager, "overlaycomplete", function (event) {
          if (event.type === "rectangle") {
            if (selectedGeometry) selectedGeometry.setMap(null);
            selectedGeometry = event.overlay;
          }
        });

        loadEarthEngine(initEarthEngine);
      }

      let lastCollection;

      function runAnalysis() {
        if (!initialized || !selectedGeometry) return;
        const bounds = selectedGeometry.getBounds();
        const region = ee.Geometry.Rectangle([
          bounds.getSouthWest().lng(), bounds.getSouthWest().lat(),
          bounds.getNorthEast().lng(), bounds.getNorthEast().lat()
        ]);
        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;
        const selectedLayer = document.getElementById("layer-select").value;

        let collection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
          .filterBounds(region).filterDate(start, end)
          .map(img => img.updateMask(img.select("QA60").not()));

        const composite = collection.median();
        const ndvi = composite.normalizedDifference(["B8", "B4"]).rename("NDVI");
        let display = ndvi;
        let vis = { min: 0, max: 1, palette: ["white", "green"] };

        if (selectedLayer === "Soil") {
          const str = composite.expression("((1 - r)**2) / (r * 2)", { r: composite.select("B12") }).rename("STR");
          const soil = composite.addBands(ndvi).addBands(str).expression("(ndvi + str) / 2", { ndvi, str }).rename("Soil");
          display = soil;
          vis = { min: 0, max: 1, palette: ["blue", "yellow", "red"] };
        }

        lastCollection = collection;

        display.getMap(vis, function (mapId) {
          const overlay = new google.maps.ImageMapType({
            getTileUrl: function (coord, zoom) {
              return `https://earthengine.googleapis.com/map/${mapId.mapid}/${zoom}/${coord.x}/${coord.y}?token=${mapId.token}`;
            },
            tileSize: new google.maps.Size(256, 256),
            name: selectedLayer
          });
          map.overlayMapTypes.clear();
          map.overlayMapTypes.push(overlay);
        });
      }

      function drawChart() {
        if (!lastCollection || !selectedGeometry) return;
        const bounds = selectedGeometry.getBounds();
        const region = ee.Geometry.Rectangle([
          bounds.getSouthWest().lng(), bounds.getSouthWest().lat(),
          bounds.getNorthEast().lng(), bounds.getNorthEast().lat()
        ]);

        const chart = ui.Chart.image.series({
          imageCollection: lastCollection.map(img => img.normalizedDifference(["B8", "B4"]).rename("NDVI")),
          region: region,
          reducer: ee.Reducer.mean(),
          scale: 30,
          xProperty: 'system:time_start'
        }).setChartType('LineChart').setOptions({
          title: "NDVI Time Series",
          hAxis: { title: 'Date' },
          vAxis: { title: 'NDVI' }
        });

        document.getElementById("chart_div").innerHTML = chart.getInfo();
      }

      function generateAnimation() {
        if (!lastCollection || !selectedGeometry) return;
        const bounds = selectedGeometry.getBounds();
        const region = ee.Geometry.Rectangle([
          bounds.getSouthWest().lng(), bounds.getSouthWest().lat(),
          bounds.getNorthEast().lng(), bounds.getNorthEast().lat()
        ]);

        const frames = lastCollection.map(function(img) {
          const ndvi = img.normalizedDifference(["B8", "B4"]).rename("NDVI");
          return ndvi.visualize({ min: 0, max: 1, palette: ["white", "green"] });
        });

        const args = { dimensions: 600, region: region, framesPerSecond: 2 };
        ee.data.getVideoThumbURL(frames, args, function(url) {
          const iframe = document.getElementById("videoFrame");
          iframe.src = url;
          iframe.style.display = "block";
        });
      }
    </script>
  </body>
</html>
