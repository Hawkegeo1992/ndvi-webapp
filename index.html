<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>üåø NDVI & Soil Moisture Viewer</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
      }
      #map {
        width: 100%;
        height: 80vh;
      }
      #controls {
        padding: 10px;
      }
      select, input, button {
        margin: 5px;
        padding: 8px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1>üåø NDVI & Soil Moisture Viewer</h1>

    <div id="controls">
      <label>Start Date:</label>
      <input type="date" id="start-date" value="2023-01-01" />
      <label>End Date:</label>
      <input type="date" id="end-date" value="2023-03-01" />
      <select id="layer-select">
        <option value="NDVI">NDVI</option>
        <option value="Soil">Soil Moisture</option>
      </select>
      <button id="runBtn" disabled onclick="runAnalysis()">Run Analysis</button>
    </div>

    <div id="map"></div>

    <!-- Google Maps + Drawing Tools -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh9JdQp5xCLsPhB7q7t8U1jLzpXYtbxFg&libraries=drawing&callback=initMap">
    </script>

    <!-- Earth Engine Loader -->
    <script>
      function loadEarthEngine(callback) {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/@google/earthengine@0.1.265/build/ee_api_js.js";
        script.onload = callback;
        script.onerror = () => console.error("‚ùå Failed to load Earth Engine API.");
        document.head.appendChild(script);
      }
    </script>

    <script>
      let map;
      let drawingManager;
      let selectedGeometry = null;
      let initialized = false;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 32.25, lng: 50.75 },
          zoom: 8,
          mapTypeId: "satellite",
        });

        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ["rectangle"]
          },
          rectangleOptions: {
            fillColor: "#ffff00",
            fillOpacity: 0.2,
            strokeWeight: 2,
            clickable: false,
            editable: false,
            zIndex: 1
          }
        });

        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, "overlaycomplete", function (event) {
          if (event.type === "rectangle") {
            if (selectedGeometry) {
              selectedGeometry.setMap(null);
            }
            selectedGeometry = event.overlay;
          }
        });

        loadEarthEngine(initEarthEngine);
      }

      window.initMap = initMap;

      function initEarthEngine() {
        if (typeof ee === 'undefined') {
          console.error("‚ùå Earth Engine API not loaded.");
          return;
        }

        ee.data.authenticateViaOauth(
          "686935018812-926ilgpd8btttcks8v763mc4gar1seb6.apps.googleusercontent.com",
          () => {
            ee.initialize(null, null, () => {
              initialized = true;
              document.getElementById("runBtn").disabled = false;
              console.log("‚úÖ Earth Engine initialized.");
            }, (err) => console.error("‚ùå EE init error:", err));
          },
          (e) => console.error("‚ùå Auth error:", e)
        );
      }

      function runAnalysis() {
        if (!initialized || typeof ee === 'undefined') {
          alert("‚ö†Ô∏è Earth Engine is not initialized yet.");
          return;
        }

        if (!selectedGeometry) {
          alert("‚ö†Ô∏è Please draw a region on the map.");
          return;
        }

        const bounds = selectedGeometry.getBounds();
        const region = ee.Geometry.Rectangle([
          bounds.getSouthWest().lng(),
          bounds.getSouthWest().lat(),
          bounds.getNorthEast().lng(),
          bounds.getNorthEast().lat()
        ]);

        const start = document.getElementById("start-date").value;
        const end = document.getElementById("end-date").value;
        const selectedLayer = document.getElementById("layer-select").value;

        const collection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED")
          .filterBounds(region)
          .filterDate(start, end)
          .map(img => img.updateMask(img.select("QA60").not()));

        const composite = collection.median();
        const ndvi = composite.normalizedDifference(["B8", "B4"]).rename("NDVI");

        if (selectedLayer === "NDVI") {
          ndvi.getMap({ min: 0, max: 1, palette: ["white", "green"] }, function (mapId) {
            const overlay = new google.maps.ImageMapType({
              getTileUrl: function (coord, zoom) {
                return `https://earthengine.googleapis.com/map/${mapId.mapid}/${zoom}/${coord.x}/${coord.y}?token=${mapId.token}`;
              },
              tileSize: new google.maps.Size(256, 256),
              name: "NDVI"
            });
            map.overlayMapTypes.clear();
            map.overlayMapTypes.push(overlay);
          });
        } else if (selectedLayer === "Soil") {
          const str = composite.expression('((1 - r)**2) / (r * 2)', {
            r: composite.select("B12")
          }).rename("STR");

          const soil = composite.addBands(ndvi).addBands(str).expression(
            '(ndvi + str) / 2',
            {
              ndvi: ndvi,
              str: str
            }
          ).rename("Soil");

          soil.getMap({ min: 0, max: 1, palette: ["red", "yellow", "blue"] }, function (mapId) {
            const overlay = new google.maps.ImageMapType({
              getTileUrl: function (coord, zoom) {
                return `https://earthengine.googleapis.com/map/${mapId.mapid}/${zoom}/${coord.x}/${coord.y}?token=${mapId.token}`;
              },
              tileSize: new google.maps.Size(256, 256),
              name: "Soil Moisture"
            });
            map.overlayMapTypes.clear();
            map.overlayMapTypes.push(overlay);
          });
        }
      }
    </script>
  </body>
</html>
